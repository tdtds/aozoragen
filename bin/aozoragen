#!/usr/bin/env ruby
# -*- coding: utf-8; -*-
#
# aozoragen: generating AOZORA format text files from scraping some ebook sites.
#
# Copyright (C) 2012 by TADA Tadashi <t@tdtds.jp>
# Distributed under GPL
#
require 'uri'
require 'pathname'

ARGV.each do |u|
	uri = URI( u )
	book = nil
	case uri.host
	when 'sai-zen-sen.jp'
		require 'aozoragen/sai-zen-sen'
		book = Aozoragen::SaiZenSen::new( uri )
	when 'renzaburo.jp'
		require 'aozoragen/renzaburo'
		book = Aozoragen::Renzaburo::new( uri )
	when 'github.com'
		case Pathname( uri.path ).basename.to_s.sub( %r|(.*?)-.*$|, '\1' )
		when 'webmysteries'
			require 'aozoragen/webmysteries'
			book = Aozoragen::Webmysteries::new( uri )
		end
	else
		p "Error: unknown URI: #{uri}"
	end
	next unless book

	meta = book.metainfo
	open( "#{meta[:id]}.00.txt", 'w' ) do |w|
		w.puts "#{meta[:title]}\n#{meta[:author].join ' / '}\n\n\n［＃改ページ］"
	end

	book.each_chapter do |chapter|
		open( "#{meta[:id]}.#{chapter[:id]}.txt", 'w' ) do |w|
			w.puts chapter[:text]
		end
	end
end
